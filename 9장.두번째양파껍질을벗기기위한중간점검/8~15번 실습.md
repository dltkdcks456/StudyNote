### 8ë²ˆ. ë‹µë³€ ì¶”ê°€ ì‹œ ëŒ“ê¸€ ê°œìˆ˜ 1 ì¦ê°€í•˜ë„ë¡ ë³€ê²½

- DBëŠ” ë°˜ì˜
  - QuestionDaoì— ëŒ“ê¸€ ê°œìˆ˜ë¥¼ updateí•˜ëŠ” êµ¬ë¬¸ì„ ë„£ì–´ì•¼ í•œë‹¤.
- âœ… í˜ì´ì§€ì— ëŒ“ê¸€ ìˆ˜ ë°˜ì˜
  - AJAX ìš”ì²­ì„ í†µí•´ í•´ë‹¹ ê°œìˆ˜ê°€ ë³€í•˜ë„ë¡ `updateCountOfAnswer` í•¨ìˆ˜ë¥¼ í™œìš©!

```js
function onSuccess(json, status){
  ...
  var countOfAnswer = json.countOfAnswer;
  updateCountOfAnswer(countOfAnswer);
}
function updateCountOfAnswer(count) {
    $(".qna-comment-count strong").text(count);
}
```

- âœ… ë‹µë³€ ì…ë ¥ í›„ ì…ë ¥ëœ ê°’ë“¤ ëª¨ë‘ ì´ˆê¸°í™”
  - í˜„ì¬ ë‹µë³€ì„ ì…ë ¥í•˜ê³  ë‚˜ì„œ ì…ë ¥ëœ ê°’ì´ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆë‹¤.
  - inputê°’ì„ valueë¥¼ ""ë¡œ ë°”ê¿”ì„œ ë‹µë³€í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ê²Œ ë˜ë©´ ê°’ë“¤ì´ ì‚¬ë¼ì§€ê²Œ ë§Œë“ ë‹¤.

```js
function onSuccess(json, status){
  var answer = json.answer;
  ...
  resetInputValue();
}

function resetInputValue() {
    $(".answerWrite input[type='text'], .answerWrite textarea").val("");
}
```

### 9. ì§ˆë¬¸ ëª©ë¡ JSON ë°ì´í„¸ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„

```java
public class QuestionListController extends AbstractController {
    private final QuestionDao questionDao = new QuestionDao();
    @Override
    public ModelAndView execute(HttpServletRequest request, HttpServletResponse response) throws Exception {

        List<Question> questions = questionDao.findAll();
        return jsonView().addObject("questions", questions);
    }
}
```

![image-20240323211034655](assets/image-20240323211034655.png)

### 10. ë‹µë³€ ì‚­ì œí•˜ê¸° ê¸°ëŠ¥ êµ¬í˜„

- DBì—ì„œ Answerê°€ ì œê±°ëœë‹¤.
- í˜ì´ì§€ì—ì„œ ì „ì²´ ì˜ê²¬ ê°œìˆ˜ê°€ ê°ì†Œí•œë‹¤.
- DBì—ì„œ countOfAnswerì˜ ê°œìˆ˜ê°€ ê°ì†Œí•œë‹¤. â†’ questionIdë¥¼ ë„˜ê²¨ì¤˜ì„œ ê°ì†Œì‹œí‚´. sqlë¬¸ë„ ë³€í™”

```js
$(".article-util button[type=submit]").click(deleteAnswer);

function deleteAnswer(e) {
    e.preventDefault();

    var article = $(this).closest("article");
    article.remove();

    var countOfAnswer = $(".qna-comment-count strong").text();
    $(".qna-comment-count strong").text(countOfAnswer - 1);

    var form = $(this).closest("form");
    var answerId = form.find("input[name='answerId']").val();

    $.ajax({
        type: 'post',
        url: '/api/qna/deleteAnswer',
        data: {answerId : answerId},
        dataType: 'json',
        error: function(xhr, status) {
            alert("error");
        },
        success: function(json, status) {
            console.log("article ì‚­ì œ");
            console.log(json.result.status);
        }
    })
}
```

```java
// questionDao.updateCountOfAnswer(questionId, 1); 1 ì¶”ê°€í•  ê²½ìš°
// questionDao.updateCountOfAnswer(questionId, -1); 1 ê°ì†Œí•  ê²½ìš°

public void updateCountOfAnswer(Long questionId, int cnt) {
        JdbcTemplate jdbcTemplate = new JdbcTemplate();
        String sql = "UPDATE QUESTIONS " +
                "SET countOfAnswer = countOfAnswer + ?" +
                "WHERE questionId = ?";
        jdbcTemplate.update(sql, cnt, questionId);
    }
```

### 11. ì§ˆë¬¸ ìˆ˜ì •

- ë¡œê·¸ì¸ ì—¬ë¶€ íŒë‹¨, ë™ì¼ ì‚¬ìš©ì ì—¬ë¶€ íŒë‹¨ ì§„í–‰

```java
public class UpdateFormQuestionController extends AbstractController {
    private final QuestionDao questionDao = new QuestionDao();

    @Override
    public ModelAndView execute(HttpServletRequest request, HttpServletResponse response) throws Exception {
        HttpSession session = request.getSession();
        if (!UserSessionUtils.isLogined(session)) {
            return jspView("redirect:/users/loginForm");
        }

        long questionId = Long.parseLong(request.getParameter("questionId"));
        Question question = questionDao.findById(questionId);
        User user = UserSessionUtils.getUserFromSession(session);
        System.out.println(user);
        if (!question.isSameUser(user)) {
            throw new IllegalStateException("ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì“´ ê¸€ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        return jspView("/qna/update.jsp").addObject("question", question);
    }
}
```

- âœ… ë™ì¼í•œ ìœ ì €ê°€ ì•„ë‹Œ ê²½ìš°ëŠ” ì—ëŸ¬ì°½ ë°œìƒ í›„ ì´ì „ í˜ì´ì§€ë¡œ ë³µê·€

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Error Handling</title>
    <script>
        window.onload = function() {
         var errorMessage = "<%= request.getAttribute("errorMessage").toString() %>";
            alert(errorMessage);
            window.history.back(); // ì‚¬ìš©ìë¥¼ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
        };
    </script>
</head>
<body>
</body>
</html>
```

![image-20240324105627146](assets/image-20240324105627146.png)

- âœ… ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ì„ ëˆŒë ¸ì„ ë•Œ ìì—°ìŠ¤ëŸ½ê²Œ show.jspë¡œ ì´ë™í•˜ë„ë¡ redirect ì§„í–‰(use case ê³ ë ¤)

```java
public class UpdateQuestionController extends AbstractController {
    private QuestionDao questionDao = new QuestionDao();

    @Override
    public ModelAndView execute(HttpServletRequest request, HttpServletResponse response) throws Exception {
        long questionId = Long.parseLong(request.getParameter("questionId"));
        String title = request.getParameter("title");
        String contents = request.getParameter("contents");
        questionDao.update(title, contents, questionId);
        return jspView("redirect:/qna/show?questionId=" + questionId);
    }
}
```

### 12. ì‹±ê¸€í†¤ íŒ¨í„´ ìƒì„±

- í´ë˜ìŠ¤ê°€ ë¡œë“œë˜ëŠ” ì‹œì ì— ë‹¨ í•œë²ˆë§Œ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ê³ , ê·¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•œë‹¤.
  - JVMì´ í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œí•˜ëŠ” ìˆœê°„ ìƒì„±ëœë‹¤.

```java
public class Singleton {
    private static final Singleton singleton = new Singleton();

    private Singleton() {
    }

    public static Singleton getInstance() {
        return singleton;
    }
}
```

- ğŸ’¥ ì•„ë˜ ì½”ë“œëŠ” ë©€í‹° ì“°ë ˆë“œ í™˜ê²½ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.
  - ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë  ìœ„í—˜ì´ ì¡´ì¬í•œë‹¤.

```java
public class Singleton {
    private static Singleton singleton;

    private Singleton() {
    }

    public static Singleton getInstance() {
        if (singleton == null) {
            singleton = new Singleton();
        }
        return singleton;
    }
}
```

- ğŸ“Œ Double-checked Locking(DCL) ì‚¬ìš©í•˜ê¸°

```java
public class Singleton {
    private static Singleton singleton;

    private Singleton() {
    }

    public static Singleton getInstance() {
        if (singleton == null) {
            synchronized (Singleton.class) {
                if (singleton == null) {
                    singleton = new Singleton();
                }
            }
        }
        return singleton;
    }
}

```

![image-20240324195125530](assets/image-20240324195125530.png)

### 13. ì§ˆë¬¸ì„ ì‚­ì œí•˜ëŠ” ì½”ë“œ ì‘ì„±

- ApiDeleteQuestionContorllerì™€ DeleteQuestionControllerì˜ ì¤‘ë³µë˜ëŠ” ë¶€ë¶„ì„ ìƒì†ì´ ì•„ë‹Œ ì¡°í•©(Composition)ì„ í™œìš©í•´ êµ¬í•œë‹¤.
- MVC íŒ¨í„´ì´ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

### 14. DIíŒ¨í„´ìœ¼ë¡œ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸ ìš©ì´í•œ ì½”ë“œë¡œ ë³€ê²½

- ğŸ’¥ publicìœ¼ë¡œ ì ‘ê·¼ ì œí•œìë¥¼ ë³€ê²½í•˜ê³  ìƒì„±ì ì£¼ì…ì„ ë§Œë“¤ì–´ì£¼ë©´ ë˜ë‚˜?

```java

public class QnaService {
    private static final QnaService qnaService = new QnaService(QuestionDao.getInstance(), AnswerDao.getInstance());

    private final QuestionDao questionDao;
    private final AnswerDao answerDao;

    public QnaService(QuestionDao questionDao, AnswerDao answerDao) {
        this.questionDao = questionDao;
        this.answerDao = answerDao;
    }

    public static QnaService getInstance() {
        return qnaService;
    }
```

- ğŸ’¥ voidíƒ€ì…ìœ¼ë¡œ returní•  ê²½ìš°ì—ëŠ” í‰ê°€ê°€ ê¹Œë‹¤ë¡­ë‹¤. ì–´ë–»ê²Œ í•´ê²°í•˜ëŠ” ê²Œ ì¢‹ì„ê¹Œ?
  - í•´ë‹¹ ë¡œì§ì—ì„œ ì›í•˜ëŠ” ë©”ì†Œë“œê°€ ëª‡ ë²ˆ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ë¡œ íŒë‹¨í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í–ˆë‹¤.

```java
@Test
void ë‹µë³€ì´_ë¹„ì—ˆì„_ê²½ìš°() throws CannotDeleteException {
    //given
    long questionId = 1L;
    Question question = new Question("user", "title", "contents");
    User user = new User("user", "password", "name", "email");
    //when
    when(questionDao.findById(questionId)).thenReturn(question);
    when(answerDao.findAllByQuestionId(questionId)).thenReturn(null);
    qnaService.deleteQuestion(1L, user);
    // then
    verify(questionDao).delete(questionId);
    verify(answerDao, never()).deleteAllByQuestionId(questionId);
}
```

- ğŸ’¥ ViewNameì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ë‹¤.
  - ControllerëŠ” ì–´ë–»ê²Œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ì•¼í•˜ë‚˜?

```java

@ExtendWith(MockitoExtension.class)
public class DeleteQuestionControllerTest {

    DeleteQuestionController deleteQuestionController;

    @Mock
    HttpServletRequest request;

    @Mock
    HttpServletResponse response;

    @Mock
    HttpSession httpSession;

    @BeforeEach
    void setup() {
        deleteQuestionController = new DeleteQuestionController();
        MockitoAnnotations.openMocks(this);
        User user = new User("user", "password", "name", "email");
        httpSession = new MockHttpSession();
        httpSession.setAttribute(UserSessionUtils.USER_SESSION_KEY, user);
    }

    @Test
    public void testDeleteQuestionNotLoggedIn() throws Exception {
        // given
        httpSession = new MockHttpSession();
        when(request.getSession()).thenReturn(httpSession);
        when(request.getParameter("questionId")).thenReturn("1");

        // when
        ModelAndView mv = deleteQuestionController.execute(request, response);

        // then
//        Assertions.assertThat("redirect:/users/loginForm").isEqualTo(mv.getView());

    }
}
```

